<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boson Motors Assistant</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span>Boson</span> Motors</h1>
        </div>
        <div id="chatArea" class="chat-area"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Ask about the vehicle...">
            <button id="sendBtn">SEND</button>
        </div>
    </div>

    <script>
        const chatArea = document.getElementById('chatArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        async function handleSend() {
            const question = userInput.value.trim();
            if (!question || sendBtn.disabled) return;

            // 1. Show User Message
            chatArea.innerHTML += `<div class="message user">${question}</div>`;
            userInput.value = '';
            userInput.focus();
            
            // 2. Show Loading
            const loadingId = 'loading-' + Date.now();
            chatArea.innerHTML += `<div class="message assistant" id="${loadingId}">Searching manual...</div>`;
            chatArea.scrollTop = chatArea.scrollHeight;
            
            sendBtn.disabled = true;

            try {
                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    body: JSON.stringify({ question })
                });
                
                const data = await response.json();
                
                // 3. Parse Markdown and Show Answer
                const rawAnswer = data.answer || "I couldn't find an answer in the manual.";
                const formattedAnswer = marked.parse(rawAnswer);
                
                let sourceText = '';
                if (data.sources?.length) {
                    const pages = [...new Set(data.sources.map(s => s.page))].sort((a,b) => a-b);
                    sourceText = `<span class="sources">ðŸ“– Page Reference: ${pages.join(', ')}</span>`;
                }

                document.getElementById(loadingId).innerHTML = formattedAnswer + sourceText;
                
            } catch (error) {
                document.getElementById(loadingId).innerText = "System error. Please try again.";
            } finally {
                sendBtn.disabled = false;
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });
    </script>
</body>
</html>